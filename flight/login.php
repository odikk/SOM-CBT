<?phpdefine("IN_LOGIN", true);define('IN_somCBT', true);$somCBT_root_path = './';$phpEx = 'php';//global $CBT_config;include($somCBT_root_path . 'common.php');$userdata = session_pagestart($user_ip, PAGE_LOGIN);init_userprefs($userdata);include($somCBT_root_path . 'includes/page_header.php');$template->set_filenames(array(	'body' => 'login_body.tpl')	); /*    *	 Session id check  *  if session id is appended in the url or set in a cookie   *  use that sid or else set to blank for later assignment.  *  Cookies are checked first  */  if (!empty($HTTP_POST_VARS['sid']) || !empty($HTTP_GET_VARS['sid'])){	$sid = (!empty($HTTP_POST_VARS['sid'])) ? $HTTP_POST_VARS['sid'] : $HTTP_GET_VARS['sid'];}else{	$sid = '';}  // if login/logout attemptif( isset($HTTP_POST_VARS['login']) || isset($HTTP_GET_VARS['login']) || isset($HTTP_POST_VARS['logout']) || isset($HTTP_GET_VARS['logout']) || ntlm_check() ){	// if user wants to login and not already logged in		if( ( isset($HTTP_POST_VARS['login']) || isset($HTTP_GET_VARS['login']) || ntlm_check() ) && !$userdata['session_logged_in'] )	{		if (ntlm_check()) {			// if already logged into the nachine using ldap get that username			$username = ntlm_get_user();		} else {			$username = isset($HTTP_POST_VARS['username']) ? trim(htmlspecialchars($HTTP_POST_VARS['username'])) : '';		}		$username = substr(str_replace("\\'", "'", $username), 0, 25);		$username = str_replace("'", "\\'", $username);		$password = isset($HTTP_POST_VARS['password']) ? $HTTP_POST_VARS['password'] : '';		// check against the users who are only active.		$sql = "SELECT user_id, username, user_password, user_active, user_level			FROM " . USERS_TABLE . "			WHERE username = '" . str_replace("\\'", "''", $username) . "'";		if ( !($result = $db->sql_query($sql)) )		{			die('Error in obtaining userdata');		}				$row = $db->sql_fetchrow($result);		if ( $CBT_config['auth_type'] == 'ldap') {			$ldap_auth_result = ldap_auth($username, $password);		}		else {			$ldap_auth_result = false;		}		// user is present in LDAP but not in mysql, so add him to mysql database and retrieve his details		if ( $row == false && $CBT_config['auth_type'] == 'ldap' && $ldap_auth_result == LDAP_AUTH_OK ) {				add_ldap_user($username);				if ( !($result = $db->sql_query($sql)) )				{					die('Error in obtaining userdata');				}				$row = $db->sql_fetchrow($result);		}		if( $row )		{							if ( ( ($CBT_config['auth_type'] == 'ldap' &&  $ldap_auth_result == LDAP_AUTH_OK )  // ldap authentication					|| ($CBT_config['auth_type'] == 'mysql' && md5($password) == $row['user_password'] ) ) // mysql authentication				 && $row['user_active'] ) {				$autologin = ( isset($HTTP_POST_VARS['autologin']) ) ? TRUE : 0;  // not used in the project										// create a new session id and register it					// session_begin is defined in includes/sessions.php file					$session_id = session_begin($row['user_id'], $user_ip, PAGE_INDEX, FALSE, $autologin); 					redirect(append_sid('index.php', true));			}			else // credentials are invalid			{				$template->assign_block_vars('switch_user_login_error', array());			}		}		else // credentials are invalid		{				$template->assign_block_vars('switch_user_login_error', array());				}	}	// if user wants to logout and logged in already	else if( ( isset($HTTP_GET_VARS['logout']) || isset($HTTP_POST_VARS['logout']) ) && $userdata['session_logged_in'] )	{		if( $userdata['session_logged_in'] )		{			// destroy the session			// session_end is defined in includes/sessions.php file			session_end($userdata['session_id'], $userdata['user_id']); 		}				// if where to redirect is set then redirect to that location or else redirect to login page		if (!empty($HTTP_POST_VARS['redirect']) || !empty($HTTP_GET_VARS['redirect']))		{			$url = (!empty($HTTP_POST_VARS['redirect'])) ? $HTTP_POST_VARS['redirect'] : $HTTP_GET_VARS['redirect'];			redirect(append_sid($url, true));		}		else		{			redirect(append_sid("login.php", true));		}	}	else	{		$url = ( !empty($HTTP_POST_VARS['redirect']) ) ? $HTTP_POST_VARS['redirect'] : "index.php";		redirect(append_sid($url, true));	}}/* *  if not login/logout then redirect to index page  *  if index page finds that user is not logged that the user is redirected to login page from there */ else{	if( $userdata['session_logged_in'] ) {		redirect(append_sid("index.php", true));	}}		$template->pparse('overall_header');				$template->pparse('body');		include($somCBT_root_path . 'includes/page_tail.php');?>