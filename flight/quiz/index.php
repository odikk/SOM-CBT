<?phpdefine('IN_somCBT', true);$phpEx = 'php';$somCBT_root_path = './../';include($somCBT_root_path . 'common.php');//var created to determine the behavior of the page: in other words, which form to show. Initially set to 'SHOW' - SMQ 11/9/05																																					   $mode = ( isset($HTTP_GET_VARS['action']) ) ? ($HTTP_GET_VARS['action']) : ( ( isset($HTTP_POST_VARS['action']) ) ? ($HTTP_POST_VARS['action']) : '') ;//grab the course ID from URL parameter or form submission - SMQ 11/8/05$cid =  ( isset($HTTP_GET_VARS['ARG1']) ) ? ($HTTP_GET_VARS['ARG1']) : ( ( isset($HTTP_POST_VARS['ARG1']) ) ? ($HTTP_POST_VARS['ARG1']) : 0) ;//grab the quiz Id - SMQ 11/9/05$qid =  ( isset($HTTP_GET_VARS['ARG2']) ) ? ($HTTP_GET_VARS['ARG2']) : ( ( isset($HTTP_POST_VARS['ARG2']) ) ? ($HTTP_POST_VARS['ARG2']) : 0) ;//following added by SMQ to add error message if no access is granted for user - SMQ$errmsg = ( isset($HTTP_GET_VARS['error']) ) ? ($HTTP_GET_VARS['error']) : ( ( isset($HTTP_POST_VARS['error']) ) ? ($HTTP_POST_VARS['error']) : '') ;//// Start session management//$userdata = session_pagestart($user_ip, PAGE_QUIZ_INDEX);init_userprefs($userdata);//// End session managementif ( $userdata['session_logged_in'] ) {	include($somCBT_root_path . 'includes/page_header.'.$phpEx);	$template->set_filenames(array(	'body' => 'quiz/index_body.tpl') );		$nav_path = '<a href="'.append_sid($somCBT_root_path.'index.php').'" class="nav">Home</a>';	// Find whether the user has access			if ($userdata['user_level'] == ADMIN) {		$sql = "SELECT * FROM ".COURSE_TABLE." WHERE course_id = ".$cid." LIMIT 1";			}	else if  ( $userdata['user_level'] == TEACHER ) {		$sql = "SELECT c.*, cu.access_level FROM " . COURSE_USERS_TABLE . " cu, ".COURSE_TABLE." c WHERE c.course_id = cu.course_id AND cu.course_id = ".$cid."  AND cu.user_id = " . $userdata['session_user_id'] ." LIMIT 1";	} else if ( $userdata['user_level'] == STUDENT) {		$sql = "SELECT c.*, cu.access_level FROM " . COURSE_USERS_TABLE . " cu, ".COURSE_TABLE." c WHERE c.course_id = cu.course_id AND c.visible = '1'  AND cu.course_id = ".$cid." AND cu.user_id = " . $userdata['session_user_id']." LIMIT 1";	}		if ($result = $db->sql_query($sql) ) {			if(	$courses = $db->sql_fetchrow($result) ) 	{ // only if the user has access						$nav_path .= ' -  <a href="'.append_sid($somCBT_root_path.'course.php?ARG1='.$cid).'" class="nav">'.$courses['course_shortname'].'</a> -  <a href="'.append_sid($somCBT_root_path.'quiz/index.php?action=show&ARG1='.$cid).'" class="nav">'.Test.'</a>' ;											$template->assign_block_vars('course_quiz',array());						if ( ($mode == 'add' ) &&( ( $userdata['user_level'] == ADMIN ) || ($courses['access_level'] == DIRECTOR) ) ){				$nav_path .= ' - Add New Test';									$template->assign_block_vars('quiz_form',array('ACTION' => append_sid('index.php'), 													'HIDDEN' => '<input type="hidden" name="ARG1" value="'.$cid.'">',													'HEAD' => 'Add New Test',													'LABEL' => '&nbsp;Create&nbsp;',													'CANCEL_LABEL' => 'Cancel',													'FORM_SUBMIT' => 'javascript:submit_form(document.quiz, \'addresp\')',													'FORM_CANCEL' => append_sid('index.php?action=show&ARG1='.$cid)																								));							$template -> assign_block_vars('quiz_form.info', array('NAME' => 'Test Title', 'VALUE' => '<input type="text" size="30" name="qname">',				'NAME2' => 'Year Used', 'VALUE2' => '<select name="qyear" size="1">														<option>0001</option>														<option>0102</option>														<option>0203</option>														<option>0304</option>													    <option>0405</option>														<option>0506</option>														<option>0607</option>														<option>0708</option>														<option>0809</option>														<option>0910</option>														</select>')); //the block ater the first NAME/VALUE pair above was added by SMQ on 1/6/05 to allow user to specify the 'year_used' for the newly created test - SMQs			} // eof add			if ( ($mode == 'addresp' ) &&( ( $userdata['user_level'] == ADMIN ) || ($courses['access_level'] == DIRECTOR) ) ){					$nav_path .= ' - Add New Test';								$template->assign_block_vars('quiz_form',array('ACTION' => append_sid('index.php?action=show&ARG1='.$cid), 													'HIDDEN' => '<input type="hidden" name="ARG1" value="'.$cid.'">',													'HEAD' => 'Add New Test - Response',													'LABEL' => '&nbsp;Test Home&nbsp;',													'FORM_SUBMIT' => 'javascript:submit_form(document.quiz, \'show\')',													'CANCEL_LABEL' => '',													'FORM_CANCEL' => append_sid('index.php?action=show&ARG1='.$cid)																								));										$sql= "INSERT INTO " .QUIZ_TABLE. " (course_id, quiz_name, year_used, lockyn) VALUES ('".$cid."', '".$HTTP_POST_VARS['qname']."', '".$HTTP_POST_VARS['qyear']."', 'n')";//year_used and post request parameters added by SMQ on 1/6/05				if ( !$db->sql_query($sql) )				{					$message = 'Error in Creating New Test!';				}				else {					$message = 'New Test has been created!';				}			$template -> assign_block_vars('quiz_form.info', array('NAME' => $message, 'VALUE' => ''));			} // eof add response			else if ( ($mode == 'show') && ( ( $userdata['user_level'] == ADMIN ) || ($courses['access_level'] == DIRECTOR) || ($courses['access_level'] == FACULTY) || ($courses['access_level'] == REVIEWER) || ($courses['access_level'] == STUDENT) ) )  {							$sql = "SELECT * FROM ". QUIZ_TABLE . " WHERE course_id = ".$cid;								if ( ($result = $db->sql_query($sql)) ) {										if (  ( $userdata['user_level'] == ADMIN ) || ($courses['access_level'] == DIRECTOR) ) {			 						$cnew = '<a href="'.append_sid('index.php?action=add&ARG1='.$cid).'\'" class= "action">New Test</a>';					}else {						$cnew = '';										}													$template->assign_block_vars('quiz',array('NEW'=> $cnew));													while( $row = $db->sql_fetchrow($result) ) 	{									if ( ( $userdata['user_level'] == ADMIN ) || ( $userdata['user_level'] == TEACHER ) ||  ( $courses['access_level'] == STUDENT ) ) 								{																if ( $courses['access_level'] == STUDENT ) { // check whether the student has already finished/reviewed the quiz										$sql2 = " SELECT timefinish, reviewed FROM ".QUIZ_ATTEMPTS_TABLE. " WHERE quiz_id = ".$row['quiz_id']." AND user_id = ". $userdata['session_user_id']. " LIMIT 1";										if ( ($result2 = $db->sql_query($sql2)) ) {											$student_attempt = $db->sql_fetchrow($result2);										}																	}																	if ( ( $userdata['user_level'] == ADMIN ) || ( $userdata['user_level'] == TEACHER ) || ( ( $courses['access_level'] == STUDENT ) && ( ( ($student_attempt['reviewed'] == '1' ) || ($student_attempt['reviewed'] == '2' ) ) ||  ($student_attempt['timefinish'] == 0)  ) ) ) {									}										$sqlqs = "SELECT * FROM ".QUIZ_SETTINGS_TABLE." WHERE quiz_id = ".$row['quiz_id']." AND timeopen <= ". time()." AND timeclose >= ".time() ;										if ( $resqs = $db->sql_query($sqlqs) ) {											while( $rowqs = $db->sql_fetchrow($resqs)) {												if( ($courses['access_level'] == STUDENT) && (isIPInRange(decode_ip($userdata['session_ip']), decode_ip($rowqs['ipfrom']), decode_ip($rowqs['ipto'])) ) )	{													$release_quiz_options = explode("#", $row['release_quiz']);													if ( ($release_quiz_options[0] == 1) && ($student_attempt['timefinish'] == 0) ) {														$template -> assign_block_vars('quiz.info', array('Q_NAME' => $row['quiz_name'],																	'Q_ID' => $row['quiz_id'],																	'AVAIL' => $row['year_used'],																	'POINTS' => $row['quiz_id']														));														$template -> assign_block_vars('quiz.info.options', array('NAME' => '&nbsp;Take Test&nbsp;', 'VALUE' => 'javascript:popUp(\''.append_sid('check.php?ARG1='.$cid.'&ARG2='.$row['quiz_id'].'&set='.$rowqs['set_id']).'\', 1400, 850, 1)'));								//														$template -> assign_block_vars('quiz.info.options', array('NAME' => '&nbsp;Take Test&nbsp;', 'VALUE' => 'javascript:popUp(\''.append_sid('start.php?ARG1='.$cid.'&ARG2='.$row['quiz_id'].'&tc='.$row['timeclose'].'&ARG3=7&att=1').'\', 730,474,1)'));																					}													if ( ($release_quiz_options[3] == 1) && ($student_attempt['reviewed'] == '2' ) ) {														$template -> assign_block_vars('quiz.info', array('Q_NAME' => $row['quiz_name'],																	'Q_ID' => $row['quiz_id'],																	'AVAIL' => $row['year_used'],																	'POINTS' => $row['quiz_id']														));														$template -> assign_block_vars('quiz.info.options', array('NAME' => '&nbsp;Review&nbsp;', 'VALUE' => 'javascript:popUp(\''.append_sid('review.php?ARG1='.$cid.'&ARG2='.$row['quiz_id'].'&set='.$rowqs['set_id']).'\', 1400, 850, 1)'));													}												} // eof student											}										}									if ( ( $userdata['user_level'] == ADMIN ) || ( $userdata['user_level'] == TEACHER ) ) {										$template -> assign_block_vars('quiz.info', array('Q_NAME' => $row['quiz_name'],																	'Q_ID' => $row['quiz_id'],																	'AVAIL' => $row['year_used'],																	'POINTS' => $row['quiz_id']										));										$template -> assign_block_vars('quiz.info.options', array('NAME' => '&nbsp;Questions&nbsp;', 'VALUE' => 'window.location=\''.append_sid('questions.php?action=all&ARG1='.$cid.'&ARG2='.$row['quiz_id'].'&ARGyr='.$row['year_used']).'\'; return false'));										if ( ($userdata['user_level'] == ADMIN) || ($courses['access_level'] == DIRECTOR) ) {																		$template -> assign_block_vars('quiz.info.options', array('NAME' => '&nbsp;Activity&nbsp;', 'VALUE' => 'window.location=\''.append_sid('activity.php?ARG1='.$cid.'&ARG2='.$row['quiz_id'].'&ARG3='.$courses['course_shortname']).'\'; return false'));											$template -> assign_block_vars('quiz.info.options', array('NAME' => '&nbsp;Reports&nbsp;', 'VALUE' => 'window.location=\''.append_sid('report.php?action=all&ARG1='.$cid.'&ARG2='.$row['quiz_id']).'\'; return false'));																		$template -> assign_block_vars('quiz.info.options', array('NAME' => '&nbsp;Settings&nbsp;', 'VALUE' => 'window.location=\''.append_sid('index.php?action=instance&ARG1='.$cid.'&ARG2='.$row['quiz_id']).'\'; return false'));											$template -> assign_block_vars('quiz.info.options', array('NAME' => '&nbsp;Duplicate&nbsp;', 'VALUE' => 'window.location=\''.append_sid('duplicate.php?action=view&ARG1='.$cid.'&ARG2='.$row['quiz_id']).'\'; return false'));										}									} // show admin buttons														} // eof show quiz to all except students							} // eof while quiz						} // eof quiz resultset					} // eof show		elseif ( ($mode == 'lock') && ( $userdata['user_level'] == ADMIN ) ) {		$sqlck = "SELECT * FROM ".QUIZ_QUESTIONS_TABLE." WHERE quiz_id = ".$qid." AND course_id = ".$cid;				$sql = "UPDATE " .QUIZ_TABLE. " SET lockyn = 'y' WHERE quiz_id = " .$qid . " AND course_id = ".$cid;				if ( !$db->sql_query($sql) )				{					$message = 'Unable to Lock the Test.';				}				else {					$message = 'The Test is now Locked.';				}				$sql2="SELECT * FROM ".QUESTIONS_TABLE." WHERE course_id = ".$cid." ORDER BY question_id";				if ($quesmv = $db->sql_query($sql2))  				{					while ($quiz_ques = $db->sql_fetchrow($quesmv) )					{						$sql3 = "UPDATE ".QUIZ_QUESTIONS_TABLE." SET ques_name = '".mysql_real_escape_string($quiz_ques['ques_name'])."', stem = '".mysql_real_escape_string($quiz_ques['stem'])."', choice1 = '".mysql_real_escape_string($quiz_ques['choice1'])."', choice2 = '".mysql_real_escape_string($quiz_ques['choice2'])."', choice3 = '".mysql_real_escape_string($quiz_ques['choice3'])						."', choice4 = '".mysql_real_escape_string($quiz_ques['choice4'])."', choice5 = '".mysql_real_escape_string($quiz_ques['choice5'])."', media_name = '".$quiz_ques['media_name']."', points = '".$quiz_ques['points']."', feedback = '".mysql_real_escape_string($quiz_ques['feedback'])."', keywords = '".mysql_real_escape_string($quiz_ques['keywords'])."', rating = '".$quiz_ques['rating']."', createdby = ".$quiz_ques['createdby'].", lastedited_by = ".$quiz_ques['lastedited_by'].", lastedited_date = ".$quiz_ques['lastedited_date']						.", allow_edit = '".$quiz_ques['allow_edit']."', source = '".$quiz_ques['source']."', qtype = '".$quiz_ques['qtype']."' WHERE quiz_id = ".$qid." AND course_id = ".$cid." AND ques_id=".$quiz_ques['question_id'];						$db->sql_query($sql3);								}				 }				$course_name = $HTTP_POST_VARS['cname'];													$template->assign_block_vars('quiz_form',array('ACTION' => append_sid('index.php?action=instance&ARG1='.$cid.'&ARG2='.$qid), 													'HIDDEN' => '<input type="hidden" name="ARG1" value="'.$cid.'"><input type="hidden" name="ARG2" value="'.$qid.'">',													'HEAD' => 'Test Lock Successful',													'LABEL' => '&nbsp;Test Instance&nbsp;',													'FORM_SUBMIT' => 'javascript:submit_form(document.quiz, \'instance\')',													'CANCEL_LABEL' => '',													'FORM_CANCEL' => append_sid('index.php?action=show&ARG1='.$cid)																								));			}//eof lock - SMQ////////////////////////////////QUIZ INSTANCE SECTION - ADDED BY SMQ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				else if ( ($mode == 'instance') && ( ( $userdata['user_level'] == ADMIN ) || ($courses['access_level'] == DIRECTOR) || ($courses['access_level'] == FACULTY) || ($courses['access_level'] == REVIEWER) || ($courses['access_level'] == STUDENT) ) )  {							$nav_path .= ' - Test Instance';				$sql = "SELECT * FROM ".QUIZ_TABLE." WHERE quiz_id = ".$qid." AND course_id = ".$cid." AND lockyn = 'y'";				if ( ($res1 = $db->sql_query($sql)) ) {					if($db->sql_numrows($res1) == 0) {						$cnew = '<a href="'.append_sid('index.php?action=lock&ARG1='.$cid.'&ARG2='.$qid).'\'" class= "action">Lock Test</a><a href="'.append_sid('index.php?action=del&ARG1='.$cid.'&ARG2='.$qid).'\'" class= "action">Delete Test</a>';					}else{						$cnew = '<a href="'.append_sid('index.php?action=addinst&ARG1='.$cid.'&ARG2='.$qid).'\'" class= "action">New Test Instance</a>';					}				}				$template->assign_block_vars('quiz',array('NEW'=> $cnew));				$sql = " SELECT q.quiz_name, q.year_used, q.lockyn, qs.* FROM ".QUIZ_TABLE. " q, ".QUIZ_SETTINGS_TABLE." qs WHERE q.course_id = " .$cid." AND q.quiz_id = ".$qid." AND q.quiz_id = qs.quiz_id " ;								if ( ($result = $db->sql_query($sql)) ) {										if (  ( $userdata['user_level'] == ADMIN ) ) {			 							$cnew = '<a href="'.append_sid('index.php?action=addinst&ARG1='.$cid.'&ARG2='.$qid).'\'" class= "action">New Test Instance</a>';					}else {						$cnew = '';										}									while( $row = $db->sql_fetchrow($result) ) 	{					if ($row['lockyn'] == 'y') {						$lckimg = '<img src="./../templates/default/images/locked.gif"';					}else{						$lckimg = '<img src="./../templates/default/images/openlck.gif"';					}					$inst_name = $row['quiz_name']."_".$row['inst_name'];					$inst_nav = '<a href="'.append_sid('settings.php?action=edit&ARG1='.$cid.'&ARG2='.$qid.'&ARG5='.$row['set_id']).'\'" class= "action">'.$inst_name.'</a>';						$template -> assign_block_vars('quiz.info', array('SET_VAL' => $inst_nav,													'LOCK' => $lckimg,													'AVAIL' => create_date($row['timeopen']).' - '.create_date($row['timeclose'])												));					} 				} 			} 			else if ( ($mode == 'addinst') && ( $userdata['user_level'] == ADMIN ) ) {				$nav_path .= ' - Add New Test Instance';									$template->assign_block_vars('quiz_form',array('ACTION' => append_sid('index.php'), 													'HIDDEN' => '<input type="hidden" name="ARG1" value="'.$cid.'"><input type="hidden" name="ARG2" value="'.$qid.'">',													'HEAD' => 'Add New Test Instance',													'LABEL' => '&nbsp;Create&nbsp;',													'CANCEL_LABEL' => 'Cancel',													'FORM_SUBMIT' => 'javascript:submit_form(document.quiz, \'addinstresp\')',													'FORM_CANCEL' => append_sid('index.php?action=instance&ARG1='.$cid.'&ARG2='.$qid)																								));							$template -> assign_block_vars('quiz_form.info', array('NAME' => 'Instance Name', 'VALUE' => '<select name="iname" size="1">														<option>primary</option>														<option>secondary</option>														</select>')); //the block ater the first NAME/VALUE pair above was added by SMQ on 1/6/05 to allow user to specify the 'year_used' for the newly created test - SMQs			} 			else if ( ($mode == 'addinstresp') && ( ( $userdata['user_level'] == ADMIN ) || ($courses['access_level'] == DIRECTOR) || ($courses['access_level'] == FACULTY) || ($courses['access_level'] == REVIEWER) || ($courses['access_level'] == STUDENT) ) ) {						$nav_path .= ' - Add New Test Instance';									$template->assign_block_vars('quiz_form',array('ACTION' => append_sid('index.php?action=instance&ARG1='.$cid.'&ARG2='.$qid), 													'HIDDEN' => '<input type="hidden" name="ARG1" value="'.$cid.'"><input type="hidden" name="ARG2" value="'.$qid.'">',													'HEAD' => 'Add New Test Instance - Response',													'LABEL' => '&nbsp;Test Home&nbsp;',													'FORM_SUBMIT' => 'javascript:submit_form(document.quiz, \'instance\')',													'CANCEL_LABEL' => '',													'FORM_CANCEL' => append_sid('index.php?action=show&ARG1='.$cid)																								));											$sql= "INSERT INTO " .QUIZ_SETTINGS_TABLE. " (quiz_id, course_id, inst_name, timeopen, timeclose) VALUES ('".$qid."', '".$cid."', '".$HTTP_POST_VARS['iname']."', '".time()."', '".time()."')";//year_used and post request parameters added by SMQ on 1/6/05					if ( !$db->sql_query($sql) )					{						$message = 'Error in Creating New Test Instance!';					}					else {						$message = 'New Test Instance has been Created!';					}				$template -> assign_block_vars('quiz_form.info', array('NAME' => $message, 'VALUE' => ''));		}		else if ( $mode == 'del' ) {			$sql = "SELECT qu.quiz_name, co.course_shortname FROM ". QUIZ_TABLE . " qu, ". COURSE_TABLE ." co where qu.quiz_id = ". $qid. " AND qu.course_id = ".$cid. " AND co.course_id = ".$cid." LIMIT 1";			if ( ($result = $db->sql_query($sql)) ) {								 if ($quiz_course = $db->sql_fetchrow($result) ) {						$course_name = $quiz_course['course_shortname'];									$sql = "DELETE FROM ".QUIZ_ATTEMPTS_TABLE." WHERE quiz_id = ".$qid;					$db->sql_query($sql);											$sql = "DELETE FROM ".QUIZ_QUESTIONS_TABLE." WHERE quiz_id = ".$qid;					$db->sql_query($sql);					$sql = "DELETE FROM ".QUIZ_RESPONSES_TABLE." WHERE quiz_id = ".$qid;					$db->sql_query($sql);					$sql = "DELETE FROM ".TEST_LOG_TABLE." WHERE quiz_id = ".$qid;					$db->sql_query($sql);										$sql = " DELETE FROM ". QUIZ_TABLE . " WHERE quiz_id = " .$qid;					unset($message);					if ( !$db->sql_query($sql) )					{						$message = 'Error in Deleting Test &nbsp;&nbsp;';					}					else {						$message = 'Test has been Deleted&nbsp;&nbsp;';					}					$sql = " DELETE FROM ". QUIZ_SETTINGS_TABLE . " WHERE quiz_id = " .$qid;					$db->sql_query($sql);  				}			}		}	} // eof of course validityelse {			redirect(append_sid("index.php", true));					} // eof no acces for the course	}		$template->assign_vars(array(				'S_ROOTDIR' => $somCBT_root_path,				'S_NAV' => $nav_path,				'S_ERR' => $errmgs)			);	}else {	if ( $userdata['user_level'] == STUDENT ) {		redirect(append_sid("index.php", true));		} else {		redirect(append_sid("login.php", true));	}}//// Generate the page//$template->pparse('overall_header');$template->pparse('body');include($somCBT_root_path . 'includes/page_tail.php');?>