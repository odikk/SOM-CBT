<?phpdefine('IN_somCBT', true);$phpEx = 'php';$somCBT_root_path = './../';include($somCBT_root_path . 'common.php');$mode =  ( isset($HTTP_GET_VARS['action']) ) ? ($HTTP_GET_VARS['action']) : ( ( isset($HTTP_POST_VARS['action']) ) ? ($HTTP_POST_VARS['action']) : '') ;$cid =  ( isset($HTTP_GET_VARS['ARG1']) ) ? ($HTTP_GET_VARS['ARG1']) : ( ( isset($HTTP_POST_VARS['ARG1']) ) ? ($HTTP_POST_VARS['ARG1']) : 0) ;$qid =  ( isset($HTTP_GET_VARS['ARG2']) ) ? ($HTTP_GET_VARS['ARG2']) : ( ( isset($HTTP_POST_VARS['ARG2']) ) ? ($HTTP_POST_VARS['ARG2']) : 0) ;$year = ( isset($HTTP_GET_VARS['ARG3']) ) ? ($HTTP_GET_VARS['ARG3']) : '';//// Start session management//$userdata = session_pagestart($user_ip, PAGE_QUIZ_REPORT);init_userprefs($userdata);//// End session managementif( $userdata['session_logged_in'] && ( ( $userdata['user_level'] == ADMIN) || ( $userdata['user_level'] == TEACHER) ) ) {	include($somCBT_root_path . 'includes/page_header.php');	$template->set_filenames(array(	'body' => 'quiz/quiz_duplicate.tpl'));	$nav_path = '<a href="'.append_sid($somCBT_root_path.'index.php').'" class="nav">Home</a> ' ;	// Find the whether the user teaches particular course	if ($userdata['user_level'] == ADMIN) {		$sql = "SELECT c.*, q.* FROM " .COURSE_TABLE." c, ".QUIZ_TABLE ." q WHERE c.course_id = ".$cid." AND q.quiz_id = ".$qid." AND q.course_id = c.course_id LIMIT 1";			}	else if ( $userdata['user_level'] == TEACHER ) {		$sql = "SELECT c.*, cu.access_level, q.* FROM " . COURSE_USERS_TABLE . " cu, ".COURSE_TABLE." c, ".QUIZ_TABLE." q WHERE c.course_id = cu.course_id AND cu.course_id = ".$cid." AND cu.user_id = " . $userdata['session_user_id'] ." AND q.quiz_id =".$qid." AND q.course_id = c.course_id LIMIT 1";	}	if ( $result = $db->sql_query($sql) ) {			if ($course_quiz = $db->sql_fetchrow($result) ) {				$nav_path .= ' -  <a href="'.append_sid($somCBT_root_path.'course.php?ARG1='.$cid).'" class="nav">'.$course_quiz['course_shortname'].'</a> -  <a href="'.append_sid('index.php?action=show&ARG1='.$cid).'" class="nav">'.Test.'</a> -  <a href="'.append_sid('questions.php?action=all&ARG1='.$cid.'&ARG2='.$qid).'" class="nav">'.$course_quiz['quiz_name'].'</a> - <a href="'.append_sid('duplicate.php?action=view&ARG1='.$cid.'&ARG2='.$qid).'" class="nav"> duplicate </a>'  ;								if ( ($mode == 'view') && (( $course_quiz['access_level'] == DIRECTOR ) || ( $course_quiz['access_level'] == FACULTY ) || ( $userdata['user_level'] == ADMIN )) ) {								$template->assign_block_vars('quiz_report',array('Q_ACTION' => 'Duplicate Quiz'	));				$template->assign_block_vars('quiz_report.info',array('Q_NAME' => '<input type="text" name="qname" size="30" value="'.$course_quiz['quiz_name'].'">&nbsp;&nbsp;',																		'Q_YEAR' => '<select name="qyear" size="1">																			<option>0001</option>																			<option>0102</option>																			<option>0203</option>																			<option>0304</option>													    					<option>0405</option>																			<option>0506</option>																			<option>0607</option>																			<option>0708</option>																			<option>0809</option>																			<option>0910</option>																			</select>',																		'OLD_YEAR' => $course_quiz['year_used'],																		'HIDDEN' => '<input type="hidden" name="action" value="save"><input type="hidden" name="ARG1" value="'.$cid.'">																		<input type="hidden" name="ARG2" value="'.$qid.'">',																		'SAVE' => '<input type="submit" name="btn_sbmt" value="Save">',																		'CANCEL' => '<input type="button" name="btn_cncl" value="Cancel" onClick="javascript:window.close();">'																			));		//				$template->assign_block_vars('quiz_report',array('Q_ACTION' => 'Download Stats'));			//				$template->assign_block_vars('quiz_report.info',array('Q_INFO' => '<input type="button" value="Excel Format" onclick="javascript:window.location=\''.append_sid('report.php?action=excel&cid='.$cid.'&qid='.$qid).'\'">&nbsp;&nbsp;<input type="button"value="XML Format"  onclick="javascript:window.location=\''.append_sid('report.php?action=xml&cid='.$cid.'&qid='.$qid).'\'">', 'Q_INPUT' => ''));				}			else if ( ($mode == 'save') && (( $course_quiz['access_level'] == DIRECTOR ) || ( $course_quiz['access_level'] == FACULTY ) || ( $userdata['user_level'] == ADMIN )) ) {			//Create new quiz record - SMQ				$sql= "INSERT INTO " .QUIZ_TABLE. " (course_id, quiz_name, year_used, lockyn) VALUES ('".$cid."', '".$HTTP_POST_VARS['qname']."', '".$HTTP_POST_VARS['qyear']."', 'n')";				if ( !$db->sql_query($sql) )				{					$message = 'Error in Duplicating Test!';				}				else {					$message = 'Test has been Duplicated! Duplicating Question References...';				}				$id_check = "SELECT MAX(quiz_id) as last FROM ".QUIZ_TABLE." WHERE course_id = ".$cid;				if ( $rescheck = $db->sql_query($id_check) ) {					if ($check = $db->sql_fetchrow($rescheck) ) {						$qid_check = $check['last'];					}				}							$sql2 = "SELECT * FROM ".QUIZ_QUESTIONS_TABLE." WHERE quiz_id = ".$qid." ORDER BY ques_order";				if ( $result2 = $db->sql_query($sql2) ) {					while ($quiz_ques = $db->sql_fetchrow($result2) ) {						$sql3 = "SELECT * FROM ".QUESTIONS_TABLE." WHERE question_id = ".$quiz_ques['ques_id']." LIMIT 1";						if ( $result3 = $db->sql_query($sql3) ) {							if ($ques = $db->sql_fetchrow($result3) ) {								$insert = "INSERT INTO ". QUIZ_QUESTIONS_TABLE . "  (quiz_id, course_id, ques_id, cat_id, ques_order) VALUES ( ".$qid_check. ", ".$cid.", ".$ques['question_id'].", ".$ques['cat_id'].", ".$quiz_ques['ques_order']." )";								$r = $db->sql_query($insert);								if ( $r ) {									$new_message = 'Test Questions Successfully Duplicated!';								}								else {									$new_message = 'Unable to Duplicate Test Questions!';								}									}						}					}				}				$template->assign_block_vars('quiz_report.info',array('MSG1' => $message, 'MSG2' => $new_message,									'CANCEL' => '<input type="button" name="btn_cncl" value="Done" onClick="javascript:window.close();">'										));			}				}		$template->assign_vars(array(				'S_ROOTDIR' => $somCBT_root_path,				'S_NAV' => $nav_path,				'Q_POST_ACTION' => append_sid('duplicate.php') )			);	}}else {	redirect(append_sid("login.php", true));}//// Generate the page//$template->pparse('overall_header');$template->pparse('body');include($somCBT_root_path . 'includes/page_tail.php');?>