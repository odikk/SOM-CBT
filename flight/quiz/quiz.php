<?phpdefine('IN_somCBT', true);$phpEx = 'php';$somCBT_root_path = './../';include($somCBT_root_path . 'common.php');$cid =  ( isset($HTTP_GET_VARS['ARG1']) ) ? ($HTTP_GET_VARS['ARG1']) : ( ( isset($HTTP_POST_VARS['ARG1']) ) ? ($HTTP_POST_VARS['ARG1']) : 0) ;$qid =  ( isset($HTTP_GET_VARS['ARG2']) ) ? ($HTTP_GET_VARS['ARG2']) : ( ( isset($HTTP_POST_VARS['ARG2']) ) ? ($HTTP_POST_VARS['ARG2']) : 0) ;$total =  ( isset($HTTP_GET_VARS['ARG3']) ) ? ($HTTP_GET_VARS['ARG3']) : ( ( isset($HTTP_POST_VARS['ARG3']) ) ? ($HTTP_POST_VARS['ARG3']) : 0) ;$offset =  ( isset($HTTP_GET_VARS['ARG4']) ) ? ($HTTP_GET_VARS['ARG4']) : ( ( isset($HTTP_POST_VARS['ARG4']) ) ? ($HTTP_POST_VARS['ARG4']) : 0) ;$media_dir =  ( isset($HTTP_GET_VARS['dir']) ) ? ($HTTP_GET_VARS['dir']) : ( ( isset($HTTP_POST_VARS['dir']) ) ? ($HTTP_POST_VARS['dir']) : '') ;$setid =  ( isset($HTTP_GET_VARS['set']) ) ? ($HTTP_GET_VARS['set']) : ( ( isset($HTTP_POST_VARS['set']) ) ? ($HTTP_POST_VARS['set']) : 0) ;//// Start session management//$userdata = session_pagestart($user_ip, PAGE_QUIZ_QUIZ);init_userprefs($userdata);//// End session managementif( $userdata['session_logged_in']) {	include($somCBT_root_path . 'includes/page_header.php');	$template->set_filenames(array(		'body' => 'quiz/quiz_body.tpl')		);	$sql = "SELECT qs.ipfrom, qs.ipto, q.release_quiz, qs.timeclose FROM ". QUIZ_TABLE. " q, ".QUIZ_SETTINGS_TABLE." qs WHERE qs.timeopen <= ".time(). " AND qs.timeclose >= ".time()." AND qs.set_id = ".$setid." AND q.quiz_id = ". $qid . " AND q.course_id = ".$cid." AND q.quiz_id=qs.quiz_id LIMIT 1";		if ($result = $db->sql_query($sql) ) {		if ($quiz = $db->sql_fetchrow($result)) {			if (isIPInRange(decode_ip($userdata['session_ip']), decode_ip($quiz['ipfrom']), decode_ip($quiz['ipto'])) ) {				$release_quiz_options = explode("#", $quiz['release_quiz']);								if ($release_quiz_options[2] == 1) { // scramble questions					$sql2 = "SELECT ques_order FROM ".QUIZ_ATTEMPTS_TABLE. " WHERE quiz_id = ".$qid." AND user_id = ".$userdata['session_user_id'];									if ($result2 = $db->sql_query($sql2) ) {						if ($qo = $db->sql_fetchrow($result2)) {							$temp = $qo['ques_order'];							$question_order = explode(",",$temp);							$new_offset = $question_order[($offset -1 )];						}					}				}				else { // sequential delivery					$new_offset = $offset ;				}								$sql = "SELECT * FROM ".QUIZ_QUESTIONS_TABLE."							WHERE quiz_id = ".$qid." AND course_id = ".$cid." AND ques_order = ".$new_offset." LIMIT 1";				if ($result = $db->sql_query($sql) ) {					if ($question = $db->sql_fetchrow($result)) {						switch ($question['qtype']) {											case MULTIPLECHOICE :							{								$sql1 = "SELECT answer, status FROM ".QUIZ_RESPONSES_TABLE . " WHERE quiz_id = ".$qid. " AND question_id = ".$question['ques_id']." AND user_id =".$userdata['session_user_id'];															$ans = '';								if ($result2 = $db->sql_query($sql1) ) {									if ( $resp = $db->sql_fetchrow($result2) ) {										$ans = $resp['answer'];									} // eof ans															}//  eof result2								if ($resp['status'] == 4 ) { // question marked									$chkbox = ' checked onclick="dosave(question_'.$offset.','.($offset).');"';								}								else if ( $resp['status'] == 2 ){									$chkbox = 'onclick="domark(question_'.$offset.','.($offset).');"';								}								else {									$chkbox = ' disabled onclick="domark(question_'.$offset.','.($offset).');"';								}								$letters = array("A.","B.","C.","D.","E.", "F.");								$ques_options = "<table border='0' cellspacing='0' cellpadding='0'> ";								for ( $z = 0; $z < 6; $z++) {									$ques_options .= "<tr>";													if (!empty($question['choice'.($z+1)])) {										$ques_options .= '<td valign="top" nowrap><span class="gen">&nbsp;&nbsp;';										$ques_options .= '<input type="radio" name="ans" value="'.($z+1).'"  onclick="dosave(question_'.$offset.','.($offset).');" '; 										if ( $ans == ($z+1) ) {											$ques_options .= ' checked';										}										$ques_options .= ' >&nbsp;&nbsp;'.$letters[$z].'&nbsp;&nbsp;</span></td><td class="gen">'.$question['choice'.($z+1)]."</td>";																}										$ques_options .= "</tr><tr><td colspan='3' height='9'></td></tr>";												}									$ques_options .= "<table>";								break;							} // eof multiplechoice							case DESCRIPTION :							{								$sql1 = "SELECT answer, status FROM ".QUIZ_TEXT_RESPONSES_TABLE . " WHERE quiz_id = ".$qid. " AND question_id = ".$question['ques_id']." AND user_id =".$userdata['session_user_id'];															$ans = '';								if ($result2 = $db->sql_query($sql1) ) {									if ( $resp = $db->sql_fetchrow($result2) ) {										$ans = $resp['answer'];									} // eof ans								}								if ($resp['status'] == 4 ) { // question marked									$chkbox = ' checked onclick="dosave(question_'.$offset.','.($offset).');"';								}								else if ( $resp['status'] == 2 ){									$chkbox = 'onclick="domark(question_'.$offset.','.($offset).');"';								}								else {									$chkbox = ' disabled onclick="domark(question_'.$offset.','.($offset).');"';								}							$btn = ' onclick="dosave(question_'.$offset.','.($offset).');"';							$ques_options = "<table border='0' cellspacing='0' cellpadding='0'> ";							$ques_options .= "<tr>";							$ques_options .= '<td valign="top" nowrap><span class="gen">&nbsp;&nbsp;';							$ques_options .= '<textarea name="ans" rows="20" cols="80">'.$ans.'</textarea>';							$ques_options .= "</tr><tr><td colspan='3' height='9'></td></tr>";							$ques_options .= '<td valign="top" nowrap><span class="gen">&nbsp;&nbsp;';							$ques_options .= '<input name="ans" type="button" value="Save Response"'.$btn.'>';							$ques_options .= "</tr><tr><td colspan='3' height='9'></td></tr>";							break;						} // eof longanswer					} // eof switch						if ( trim($question['media_name']) != '' ) {							$media_array = explode(",",$question['media_name']);							if (substr($media_array[0], -3) == 'mov') {								//print_r(getimagesize($somCBT_root_path.'media/'.$courses['media_dir'].$question['media_name']));								$media = '<center><object classid="clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B" codebase="http://www.apple.com/qtactivex/qtplugin.cab"  width="'.$media_array[1].'" height="'.($media_array[2]+16).'">';								$media .= '<param name="SRC" value="'.$somCBT_root_path.'media/'.$HTTP_GET_VARS['dir'].$media_array[0].'">';								$media .= '<param name="AUTOPLAY" value="true"> <param name="CONTROLLER" value="true">';								$media .= '<embed src="'.$somCBT_root_path.'media/'.$HTTP_GET_VARS['dir'].$media_array[0].'" autoplay="true" width="'.$media_array[1].'" height="'.($media_array[2]+16).'" controller="true" pluginspage="http://www.apple.com/quicktime/download/"></embed>'; 								$media .= '</object></center>';							}							else {								$media='<center><img src="'.$somCBT_root_path.'media/'.$HTTP_GET_VARS['dir'].$media_array[0].'" border="0" alt="media"></center>';							}						}							$template->assign_block_vars('question',array('QNO' => $offset,																		'QID' => $question['ques_id'],																		'CHKBOX' => $chkbox,																		'STEM' => $question['stem']."<br><br>".$media,																		'ATTRIBUTES' => $ques_options																						));										} // eof if question									} // eof resultset				} // eof IP in range		} // eof quiz fetch row	} // eof quiz resultset			$template->assign_vars(array(			'S_ROOTDIR' => $somCBT_root_path,			'TOTAL' => $total,			'Q_FORM_ACTION' => append_sid('status.php'),			'COURSE_ID' => $cid,					'QUIZ_ID' => $qid,			'SET_ID' => $setid,			'OFFSET' => $offset,			'L_LOGIN_LOGOUT' => '', // remove the logout link from the top			'SCRIPT' => '<script>top.setcountdown('.create_date($quiz['timeclose'],1, "Y,m,d,H,i,s").')</script>',			'S_NAV' => $nav_path)		);}else {	redirect(append_sid("login.php", true));}//// Generate the page//$template->pparse('overall_header');$template->pparse('body');include($somCBT_root_path . 'includes/page_tail.php');?>