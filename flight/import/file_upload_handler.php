<?$userfile = $HTTP_POST_FILES['userfile']['tmp_name'];$userfile_name = $HTTP_POST_FILES['userfile']['name'];$userfile_size = $HTTP_POST_FILES['userfile']['size'];$userfile_type = $HTTP_POST_FILES['userfile']['type'];//$cid = $HTTP_POST_VARS['c_id'];//$ca = $HTTP_POST_VARS['cat'];//ensure that a file was uploaded - SMQ 8/20/2005if ($userfile=="none"){	echo "Problem: no file uploaded";	exit;}//ensure that the file uploaded has some content - SMQ 8/20/2005if ($userfile_size==0){	echo "Problem: uploaded file is zero length";	exit;}//ensure that the file is of the correct type - alternate is binary - SMQ 8/20/2005if ($userfile_type != "text/plain"){echo "Problem: file is not plain text";exit;}//ensure that the file we are testing has been uploaded to the server and is not a local file - SMQ 8/20/2005if (!is_uploaded_file($userfile)){echo "Problem: possible file upload attack";exit;}//copy file from temporary server folder to permanent uploads dir. It is from here that we will further process the //file and create a database record ( or records ) of the questions. This directory is safely outside the document //tree - SMQ 8/20/2005.$upfile = "/Library/WebServer/Documents/home/uploads/" .$userfile_name;if ( !copy($userfile, $upfile)){echo "Problem: Could not move file into directory";  exit;}//open the file - SMQ 8/20/2005echo " -- File uploaded successfully!<br><br>";$fp = fopen($upfile, "r");$contents = fread ($fp, filesize ($upfile));fclose ($fp);//remove any html or php content from the file - SMQ 8/20/2005//echo " -- Removing Tag content...<br><br>";//$contents = strip_tags($contents);$fp = fopen($upfile, "w");fwrite($fp, $contents);fclose($fp);//print preview of file to browser - SMQ 8/20/2005echo "-- Begin Question Delineation...<br><hr>";//echo $contents;//read the file into a string or BLOB - SMQ 8/22/05$ques_blob = file_get_contents( "/Library/WebServer/Documents/home/uploads/" .$userfile_name);$ques_str = str_replace("# Start of question:", "#", $ques_blob);$ques_str = str_replace("# End of question:", "", $ques_str);$ques_str = str_replace(":TITLE:", "^", $ques_str);$ques_str = str_replace(":FEEDBACK:", "^", $ques_str);$ques_str = str_replace(":IMAGE:", "^", $ques_str);$ques_str = str_replace("<b>", "", $ques_str);$ques_str = str_replace("</b>", "", $ques_str);$ques_str = str_replace("<br>", "", $ques_str);$ques_str = str_replace("<BR>", "", $ques_str);$ques_str = str_replace('<IMG src="', '~', $ques_str);$ques_str = str_replace('.jpg"', '~', $ques_str);$ques_str = str_replace(":H", ":", $ques_str);$ques_str = str_replace(":QUESTION:", "^", $ques_str);$ques_str = str_replace(":INDICES:", "^", $ques_str);$ques_str = str_replace(":CAT:", "^", $ques_str);//print_r($ques_str);$quest1 = explode("#", $ques_str);//delineate question section - SMQ$count1 = count($quest1);//count total number of questions - SMQ$qtrash = array_shift($quest1);//loop through each question section and pull out each question's parts. It works out so that in numerical-array//index addressing, 0-trash, 1-name, 2-feedback, 3-stem, 4-trash, 5-option/answer, 6-trash. - SMQfor ($i=0; $i<$count1; $i++){	$questpart_str = $quest1[$i];//set each section to a string variable...	$questpart_arr = explode("^", $questpart_str);//delineate each question's parts; we'll write these to the database later - SMQ	$name = $questpart_arr[1];//grab the question name or title - SMQ	$feed = $questpart_arr[2];//grab the question feedback section - SMQ	$qstem = $questpart_arr[3];//grab the question stem section - SMQ		$img_arr = explode("~", $qstem);	$img_yn = count($img_arr);	if($img_yn > 1) {		$imagestr = $img_arr[1];//if we have more than one element in the image-evaluation array, then we assume that this question								//has an image which will always be at position number 1 in the array - smq		$imgget = explode("/", $imagestr);		$imgcnt = count($imgget);		$place = $imgcnt-1;		$image_ref = $imgget[$place].".jpg";	}	$stem = $img_arr[0];	$answr_str = $questpart_arr[5];//set answer/option section to a string so that we can break it out into array for evaluation - SMQ	$answr_arr = explode(":", $answr_str);//split array - SMQ	$trash = array_shift($answr_arr);	//$numopt = ($answr_cnt - 1)/3;	//echo $numopt."<br>";	$answr_parts = array_chunk($answr_arr, 3);	$answr_cnt = count($answr_parts);	if($answr_cnt > 5) {	//If we find a question with more than five options, the script will bail and print an error message to user - SMQ	die("ERROR: Question number ".$i." has more than 5 answer options which cannot be handled by the database. Please correct or delete, and submit again.");	}	//echo $answr_cnt."<br>";	//print_r($answr_parts);	$points = "";	unset($choices);	for ($j=0; $j<$answr_cnt; $j++) {		$points = $points . ($answr_parts[$j][1]/100)."#";		$choice[$j] = $answr_parts[$j][2];	}	$quiz_ques[ $i] = array($name, $stem, array($choice), $image_ref, $points, $feed);		}					require_once('mysql_connect.php');				for ($i=1; $i < count($quiz_ques); $i++){	echo $quiz_ques[ $i][0]."<br>";	echo $quiz_ques[ $i][1]."<br>";	echo $quiz_ques[ $i][2][0][0]."<br>";	echo $quiz_ques[ $i][2][0][1]."<br>";	echo $quiz_ques[ $i][2][0][2]."<br>";	echo $quiz_ques[ $i][2][0][3]."<br>";	echo $quiz_ques[ $i][2][0][4]."<br>";	echo $quiz_ques[ $i][3]."<br>";	echo $quiz_ques[ $i][4]."<br>";	echo $quiz_ques[ $i][5]."<br>";				$sql = "INSERT INTO questions VALUES ('', '".$ca."', '".$cid."', '".$quiz_ques[ $i][0]."', '".$quiz_ques[ $i][1]."', '".$quiz_ques[ $i][2][0][0]."', '".$quiz_ques[ $i][2][0][1]."', '".$quiz_ques[ $i][2][0][2]."', '".$quiz_ques[ $i][2][0][3]."', '".$quiz_ques[ $i][2][0][4]."', '".$quiz_ques[ $i][3]."', '".$quiz_ques[ $i][4]."', '".$quiz_ques[ $i][5]."', ' ', '0', 'admin', 'admin', ".time().", '0', 'webct', '1') "; 		$result = @mysql_query($sql);				if ($result) {			echo "Question number ". $i ."was successfully written to the database! <br>";		}else{		echo '<font color="red">There was a problem writing question number'. $i .' to the database! </font><br>';		}	}mysql_close();?>