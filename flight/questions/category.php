<?php/* * Add/ Deletes category  * Edit the category name */ define('IN_somCBT', true);$phpEx = 'php';$somCBT_root_path = './../';include($somCBT_root_path . 'common.php');$mode = ( isset($HTTP_GET_VARS['action']) ) ? ($HTTP_GET_VARS['action']) : ( ( isset($HTTP_POST_VARS['action']) ) ? ($HTTP_POST_VARS['action']) : '') ;$cid =  ( isset($HTTP_GET_VARS['ARG1']) ) ? ($HTTP_GET_VARS['ARG1']) : ( ( isset($HTTP_POST_VARS['ARG1']) ) ? ($HTTP_POST_VARS['ARG1']) : 0) ; // course id$ca =  ( isset($HTTP_GET_VARS['ARG2']) ) ? ($HTTP_GET_VARS['ARG2']) : ( ( isset($HTTP_POST_VARS['ARG2']) ) ? ($HTTP_POST_VARS['ARG2']) : 0) ; // category id//// Start session management//$userdata = session_pagestart($user_ip, PAGE_QUIZ_INDEX);init_userprefs($userdata);$usr = $userdata['username'];//// End session management// Only admins/teeachers has access to this page// if students attempts to access this page directly he/she will be directed to the inndex pageif( ( $userdata['session_logged_in'] ) && ( ($userdata['user_level'] == ADMIN) || ($userdata['user_level'] == TEACHER )) ) {	if ($mode == 'upload') {			redirect(append_sid("questions/question_get.php?ARG1=".$cid."&ARG2=".$ca."&ARG3=".$usr, true));	}		if ($mode == 'images') {			redirect(append_sid("questions/image_get.php?ARG1=".$cid."&ARG2=".$ca, true));	}	if ($mode == 'view') {			redirect(append_sid("questions/index.php?action=view&ARG1=".$cid."&ARG2=".$ca, true));	}	include($somCBT_root_path . 'includes/page_header.php');	$template->set_filenames(array(	'body' => 'questions/category.tpl')	);							$nav_path = '<a href="'.append_sid($somCBT_root_path.'index.php').'" class="nav">Home</a> ' ;	// Find the whether the user teaches particular course	if ($userdata['user_level'] == ADMIN) {		$sql = "SELECT * FROM " .COURSE_TABLE." WHERE course_id = ".$cid."  LIMIT 1";			}	else if ( $userdata['user_level'] == TEACHER ) {		$sql = "SELECT c.*, cu.access_level FROM " . COURSE_USERS_TABLE . " cu, ".COURSE_TABLE." c WHERE c.course_id = cu.course_id AND cu.course_id = ".$cid." AND cu.user_id = " . $userdata['session_user_id'] ." LIMIT 1";	}	if ( $result = $db->sql_query($sql) ) {			$courses = $db->sql_fetchrow($result) ;	}	// reviewers has no access 		if ( ( $cid == $courses['course_id']) && ( ( $userdata['user_level'] == ADMIN ) || ( $courses['access_level'] == DIRECTOR ) || ( $courses['access_level'] == FACULTY ) ) )  {		$nav_path .= ' -  <a href="'.append_sid($somCBT_root_path.'course.php?ARG1='.$cid).'" class="nav">'.$courses['course_shortname'].'</a> -  <a href="'.append_sid($somCBT_root_path.'questions/index.php?ARG1='.$cid).'" class="nav">'.Questions.'</a> - Category' ;        // Edit the category name				if  ($mode == 'edit' ){						$sql = "SELECT * FROM ".CATEGORY_TABLE. " WHERE cat_id =".$ca." LIMIT 1";							if ( ($result = $db->sql_query($sql)) ) {						if( $cat = $db->sql_fetchrow($result) )	{						$template->assign_block_vars('category', array('HEAD' => 'Edit Category',											'FORM_ACTION' => append_sid('category.php'),											'FORM_HIDDEN' => '<input type="hidden" name="ARG1" value='.$cid.'>																<input type="hidden" name="ARG2" value='.$ca.'>'								));													$template->assign_block_vars('category.members', array('NAME' => 'Category Name','VALUE' => '<input type="text" name="catname" value="'.$cat['cat_name'].'">' ));										$template->assign_block_vars('category.buttons', array('NAME' => 'Save', 'VALUE' => 'javascript:submit_form(document.settings, \'save\');'));					$template->assign_block_vars('category.buttons', array('NAME' => 'Cancel', 'VALUE' => 'window.location=\''.append_sid('index.php?action=view&ARG1='.$cid.'&ARG2='.$ca).'\' ;'));										}			} // eof resultset							} // eof edit		else if  ($mode == 'save' ) {			$template->assign_block_vars('category', array('HEAD' => 'Edit Category - Response',																'FORM_ACTION' => '','FORM_HIDDEN' => ''										));						$sql= "UPDATE " .CATEGORY_TABLE. " SET cat_name = '". $HTTP_POST_VARS['catname']. "' WHERE cat_id = ".$ca;			if ( !$db->sql_query($sql) ){				$message = 'Error in Updating Category';			}else {				$message = 'Category has been updated';			}			$template->assign_block_vars('category.members', array('NAME' => $message,	'VALUE' => '' ));						$template->assign_block_vars('category.buttons', array('NAME' => 'Return to Category',											'VALUE' => 'window.location=\''.append_sid('index.php?action=view&ARG1='.$cid.'&ARG2='.$ca).'\' ;'									));		}// eof save		else if  ($mode == 'new' ) {						$template->assign_block_vars('category', array('HEAD' => 'Create a New Category',											'FORM_ACTION' => append_sid('category.php'),											'FORM_HIDDEN' => '<input type="hidden" name="ARG1" value='.$cid.'>'										));							$template->assign_block_vars('category.members', array('NAME' => 'Category Name','VALUE' => '<input type="text" name="catname" value="">' ));												$template->assign_block_vars('category.buttons', array('NAME' => 'Create New', 'VALUE' => 'javascript:submit_form(document.settings,\'addresp\');'));			$template->assign_block_vars('category.buttons', array('NAME' => 'Cancel', 'VALUE' => 'window.location=\''.append_sid('index.php?ARG1='.$cid).'\' ;'));								} // eof new category		else if ($mode == 'addresp' ) {			$template->assign_block_vars('category', array('HEAD' => 'Create a New Category - Response', 'FORM_ACTION' => '', 'FORM_HIDDEN' => ''));						$sql= "INSERT INTO " .CATEGORY_TABLE. " (cat_name, course_id) VALUES ".	"('".$HTTP_POST_VARS['catname']."', ".$cid.")";			if ( !$db->sql_query($sql) ){				$message = 'Error in Creating New Category';			}else {				$message = 'Category has been created';			}			$template->assign_block_vars('category.members', array('NAME' => $message,	'VALUE' => '' ));							$template->assign_block_vars('category.buttons', array('NAME' => 'Return', 'VALUE' => 'window.location=\''.append_sid('index.php?action=view&ARG1='.$cid).'\' ;' ));		}// eof add new resp		elseif ($mode == 'del' ) {				$sql = "SELECT * FROM ".CATEGORY_TABLE. " WHERE cat_id =".$ca." LIMIT 1";			if ( ($result = $db->sql_query($sql)) ) {								if ($cat = $db->sql_fetchrow($result) ) {						/* 					 *  All details reagrding the questions in that category should also be deleted					 *  improvememtns - Use stored procedure for this purpose - KPG. SMQ agrees but stored procedures not available with our					 *  version of mySQL - SMQ.					 */					$sql2 = "SELECT question_id FROM ".QUESTIONS_TABLE. " WHERE cat_id = ".$ca;										if ( ($result2= $db->sql_query($sql2)) ) {										while ($questions = $db->sql_fetchrow($result2) ) {					//The following sql statements were commented out in order to unlink referential integrity between 					//the 'questions' and 'quiz_questions' tables - SMQ							//$sql = "DELETE FROM ".QUIZ_QUESTIONS_TABLE." WHERE ques_id = ".$questions['question_id'];							//$db->sql_query($sql);											$sql = "DELETE FROM ".QUESTION_COMMENTS_TABLE." WHERE question_id = ".$questions['question_id'];							$db->sql_query($sql);								//$sql = "DELETE FROM ".STATISTICS_TABLE." WHERE question_id = ".$questions['question_id'];							//$db->sql_query($sql);											//$sql = "DELETE FROM ".QUIZ_RESPONSES_TABLE." WHERE question_id = ".$questions['question_id'];							//$db->sql_query($sql);							$sql = "DELETE FROM ".QUESTIONS_TABLE." WHERE question_id = ".$questions['question_id'];							$db->sql_query($sql);																			}					}										$sql = " DELETE FROM ". CATEGORY_TABLE . " WHERE cat_id = " .$ca;					unset($message);										if ( !$db->sql_query($sql) ) {						$message = 'Error in Deleting Category&nbsp;&nbsp;';					}else {						$message = 'Category has been Deleted&nbsp;&nbsp;';					}					$template->assign_block_vars('category', array('HEAD' => 'Delete Category - Response',													'FORM_ACTION' => '', 'FORM_HIDDEN' => ''												));													$template->assign_block_vars('category.members', array('NAME' => $message,'VALUE' => '' ));																$template->assign_block_vars('category.buttons', array('NAME' => 'Return to Category', 'VALUE' => 'window.location=\''.append_sid('index.php?action=view&ARG1='.$cid).'\' ;' )); 				 } // eof fetchrow			} // eof resultset		} // eof delete	} // eof course permission/valid	$template->assign_vars(array(				'S_ROOTDIR' => $somCBT_root_path,				'S_NAV' => $nav_path)			);	}else {	if ( $userdata['user_level'] == STUDENT ) {		redirect(append_sid("index.php", true));		} else {		redirect(append_sid("login.php", true));	}}//// Generate the page//$template->pparse('overall_header');$template->pparse('body');include($somCBT_root_path . 'includes/page_tail.php');?>