<?phpdefine('IN_somCBT', true);$phpEx = 'php';$somCBT_root_path = './../';include($somCBT_root_path . 'common.php');//// Start session management//$userdata = session_pagestart($user_ip, PAGE_USERS);init_userprefs($userdata);//// End session management$mode = ( isset($HTTP_GET_VARS['action']) ) ? ($HTTP_GET_VARS['action']) : ( ( isset($HTTP_POST_VARS['action']) ) ? ($HTTP_POST_VARS['action']) : '') ;//$cid =  ( isset($HTTP_GET_VARS['cid']) ) ? ($HTTP_GET_VARS['cid']) : ( ( isset($HTTP_POST_VARS['cid']) ) ? ($HTTP_POST_VARS['cid']) : 0) ;$gid =    ( isset($HTTP_POST_VARS['gid']) ) ? ($HTTP_POST_VARS['gid']) : 0 ;if(  $userdata['session_logged_in'] ) {	if( $userdata['user_level'] == ADMIN ) {		include($somCBT_root_path . 'includes/page_header.php');		$template->set_filenames(array(			'body' => 'users/groups_body.tpl')		);			$nav_path = '<a href="'.append_sid('groups.php').'" class="nav"> Groups </a>';		if  ( $userdata['user_level'] == ADMIN)		{			$template->assign_block_vars('user_admin',array('TH_NAME' => '&nbsp;&nbsp;Groups - Admin'));			$template->assign_block_vars('user_admin.links', array('A_NAME' => 'Add Group','A_LINK' => append_sid('groups.php?action=add')));			$template->assign_block_vars('user_admin.links', array('A_NAME' => 'Edit Name','A_LINK' =>  append_sid('groups.php?action=edit')));			$template->assign_block_vars('user_admin.links', array('A_NAME' => 'Delete Group','A_LINK' => append_sid('groups.php?action=delete')));			$template->assign_block_vars('user_admin.links', array('A_NAME' => 'Assign to Group','A_LINK' => append_sid('groups.php?action=assign')));					}		if ( ($mode == 'add' ) ){			$nav_path .= ' - Add New Group';							$sql = " SELECT * FROM ".GROUPS_TABLE;						if ($result_gp = $db->sql_query($sql) ) {				while ($groups = $db->sql_fetchrow($result_gp)) {					$gp_select_option .= '<option value="'.$groups['group_id'].'">'.$groups['group_name'].'</option>';				}			}								$template->assign_block_vars('user',array('C_POST_ACTION' => append_sid('groups.php'), 'C_ACTION' => 'Add New Group'));							$template -> assign_block_vars('user.info', array('C_INFO' => 'Current Groups', 'C_INPUT' => '<select name="group">'.$gp_select_option.'</select>'));				$template -> assign_block_vars('user.info', array('C_INFO' => 'New Group Name', 'C_INPUT' => '<input type="text" size="20" name="gname">'));								$template -> assign_block_vars('user.info', array('C_INFO' => '<input type="hidden" name="action" value="addresp"><input type="submit" value="Add New">', 'C_INPUT' => ''));				} // eof add			elseif ( ($mode == 'addresp' ) && (  $userdata['user_level'] == ADMIN ) ){				$nav_path .= ' - Add New Group - Response';			$sql =" INSERT INTO ". GROUPS_TABLE ." (group_name) VALUES " . "									('".$HTTP_POST_VARS['gname']."')";			if ( !$db->sql_query($sql) ) {				$message = 'Error in Adding New Group';			}else {				$message = 'New group <b>'.$HTTP_POST_VARS['gname'].' </b> has been Added';			}			$template->assign_block_vars('user',array('C_POST_ACTION' => append_sid('groups.php'), 'C_ACTION' => 'Add New Group - Response'));						$template -> assign_block_vars('user.info', array('C_INFO' => $message, 'C_INPUT' => ''));					unset($message);										} // eof add response		elseif ( ($mode == 'edit' ) ){			$nav_path .= ' - Edit Group Name';						$template->assign_block_vars('user',array('C_POST_ACTION' => append_sid('groups.php'), 'C_ACTION' => 'Edit Group Name'));			$sql = " SELECT * FROM ".GROUPS_TABLE." WHERE group_id >3";					if ($result_gp = $db->sql_query($sql) ) {				while ($groups = $db->sql_fetchrow($result_gp)) {					$gp_select_option .= '<option value="'.$groups['group_id'].'">'.$groups['group_name'].'</option>';				}			}			$template -> assign_block_vars('user.info', array('C_INFO' => 'Group Name', 'C_INPUT' => '<select name="gid">'.$gp_select_option.'</select>'));			$template -> assign_block_vars('user.info', array('C_INFO' => 'New Group Name', 'C_INPUT' => '<input type="text" size="20" name="gname">'));										$template -> assign_block_vars('user.info', array('C_INFO' => '<input type="hidden" name="action" value="update"><input type="submit" value="Update">', 'C_INPUT' => ''));													} // eof edit		elseif ( (strcasecmp($mode, 'update') == 0 ) ){				$nav_path .= ' - Update Group Name';			$sql = "UPDATE ". GROUPS_TABLE ." SET group_name = '".$HTTP_POST_VARS['gname']."' 							WHERE group_id = ".$HTTP_POST_VARS['gid'];							if ( !$db->sql_query($sql) )			{				$message = 'Error in Updating Group Name';			} else {				$message = 'Group Name has been Updated to ' . $HTTP_POST_VARS['gname'];			}											$template->assign_block_vars('user',array('C_POST_ACTION' => append_sid('groups.php'), 'C_ACTION' => 'Update Group Name - Response'));						$template -> assign_block_vars('user.info', array('C_INFO' => $message, 'C_INPUT' => ''));					unset($message);										} // eof save		/**		  * Permanent Delete of the group and all its user		  * Delete all the related records associated with the user		  **/		elseif ( (strcasecmp($mode, 'delete') == 0 ) && (  $userdata['user_level'] == ADMIN ) ){ 						$nav_path .= ' - Delete Group';								$template->assign_block_vars('user',array('C_POST_ACTION' => append_sid('groups.php'), 'C_ACTION' => 'Delete Group'));							$sql = " SELECT * FROM ".GROUPS_TABLE." WHERE group_id > 3";						if ($result_gp = $db->sql_query($sql) ) {				while ($groups = $db->sql_fetchrow($result_gp)) {					$gp_select_option .= '<option value="'.$groups['group_id'].'">'.$groups['group_name'].'</option>';				}			}									$template -> assign_block_vars('user.info', array('C_INFO' => 'Group to be DELETED ', 'C_INPUT' => '<select name="group">'.$gp_select_option.'</select>'));			$template -> assign_block_vars('user.info', array('C_INFO' => '<input type="hidden" name="action" value="delconfirm"><input type="button" value="Delete Group" onclick="javascript:submit_form(document.group ,\'del\')">', 'C_INPUT' => ''));						}// eof delete		elseif ( (strcasecmp($mode, 'del') == 0 ) && (  $userdata['user_level'] == ADMIN ) ){ 							$nav_path .= ' - Delete Group Response'; 			$template->assign_block_vars('user',array('C_POST_ACTION' => append_sid('groups.php'), 'C_ACTION' => 'Delete Group Response'));							$sql = "SELECT user_id FROM ".USERS_TABLE. " WHERE user_group = ".$_POST['group'];			if ($result_gp = $db->sql_query($sql) ) {				while ($users = $db->sql_fetchrow($result_gp)) {					$sql = " DELETE FROM ". USERS_TABLE . " where  user_id = ".$users['user_id'];					$db->sql_query($sql);//					echo $sql."<br>";					$sql = " DELETE FROM ". COURSE_USERS_TABLE . " where  user_id = ".$users['user_id'];					$db->sql_query($sql);//					echo $sql."<br>";					$sql = " DELETE FROM ". QUIZ_ATTEMPTS_TABLE . " where  user_id = ".$users['user_id'];					$db->sql_query($sql);//					echo $sql."<br>";					$sql = " DELETE FROM ". QUIZ_RESPONSES_TABLE . " where  user_id = ".$users['user_id'];					$db->sql_query($sql);//					echo $sql."<br>";				}			}			$sql = "DELETE FROM ".GROUPS_TABLE ." WHERE group_id = ".$_POST['group'];			$db->sql_query($sql);//			echo $sql;		} // eof delete response		elseif ( ($mode == 'assign' ) ){			$nav_path .= ' - Assign Group to Users';							$sql = " SELECT * FROM ".GROUPS_TABLE. " WHERE group_id > 1";						if ($result_gp = $db->sql_query($sql) ) {				while ($groups = $db->sql_fetchrow($result_gp)) {					$gp_select_option .= '<option value="'.$groups['group_id'].'">'.$groups['group_name'].'</option>';				}			}								$template->assign_block_vars('user',array('C_POST_ACTION' => append_sid('groups.php'), 'C_ACTION' => 'Assign Group'));							$template -> assign_block_vars('user.info', array('C_INFO' => 'Group Name', 'C_INPUT' => '<select name="group">'.$gp_select_option.'</select>'));				$template -> assign_block_vars('user.info', array('C_INFO' => 'Usernames', 'C_INPUT' => '<textarea name="unames" rows="6" cols="40"></textarea><br><span class="helptext">(seperate by commas)</span>'));						$template -> assign_block_vars('user.info', array('C_INFO' => '<input type="hidden" name="action" value="assignresp"><input type="submit" value="Assign">', 'C_INPUT' => ''));				} // eof assign		elseif ( ($mode == 'assignresp' ) && (  $userdata['user_level'] == ADMIN ) ){						$nav_path .= ' - Assign Group to Users Response';								$template->assign_block_vars('user',array('C_ACTION' => ' Assign Group to Users Response'));			$user_names = explode(",", $HTTP_POST_VARS['unames']);											array_walk($user_names,create_function('&$v', '$v="\'".trim($v)."\'";') ); // added quotes for each user name like 'kpg'						$sql = "UPDATE " .USERS_TABLE. " SET user_group = ".$_POST['group']." WHERE username IN (" .implode (",",  $user_names ). ")";			$result = $db->sql_query($sql);					$template -> assign_block_vars('user.info', array('C_INFO' => 'Number of Users added to the Group&nbsp;&nbsp;&nbsp;&nbsp;: &nbsp;'.$db->sql_query($sql), 'C_INPUT' => ''));												unset($temp, $avail_names, $user_names);			}// eof assign response		$template->assign_vars(array(			'S_ROOTDIR' => $somCBT_root_path,			'S_NAV' => $nav_path			));	}	else {		redirect(append_sid("index.php", true));	}}else {	redirect(append_sid("login.php", true));}//// Generate the page//$template->pparse('overall_header');$template->pparse('body');include($somCBT_root_path . 'includes/page_tail.php');?>